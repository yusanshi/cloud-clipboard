<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Cloud Clipboard</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.2/font/bootstrap-icons.min.css"
    />
    <style>
      .container {
        max-width: 900px;
      }
      img {
        max-width: 100%;
        max-height: 400px;
        border: 1px solid #ddd;
        border-radius: 5px;
      }
      .collapsing {
        transition: height 0.25s ease;
      }
    </style>
  </head>

  <body>
    <div class="container my-md-5">
      <div class="bg-primary-subtle rounded p-4 my-4">
        <div class="mb-3">
          <h3>Cloud</h3>
        </div>
        <div id="cloud" class="text-center"></div>
      </div>

      <div class="text-center">
        <div class="btn-group btn-group-lg my-2">
          <button
            type="button"
            class="btn btn-outline-primary"
            onclick="pullToLocal()"
          >
            <i class="bi-cloud-download"></i> Pull to local
          </button>
          <button
            type="button"
            class="btn btn-outline-success"
            onclick="pushToCloud()"
          >
            <i class="bi-cloud-upload"></i> Push to cloud
          </button>
        </div>
      </div>

      <div class="bg-success-subtle rounded p-4 my-4">
        <div class="mb-3">
          <h3 class="d-inline align-middle">Local</h3>
          <button
            type="button"
            class="btn btn-outline-success m-2 align-middle"
            onclick="getAndShowLocalClipboard()"
          >
            Retry/Refresh
          </button>
        </div>
        <div id="local" class="text-center"></div>
      </div>

      <br />

      <div class="mb-2">
        <label
          for="log"
          class="form-label text-decoration-underline"
          data-bs-toggle="collapse"
          href="#logCollapse"
          role="button"
          aria-expanded="false"
          aria-controls="logCollapse"
          >View log</label
        >
        <div class="collapse" id="logCollapse">
          <textarea
            class="form-control"
            rows="8"
            id="log"
            style="font-size: 0.8em"
            readonly
          ></textarea>
        </div>
      </div>

      <div class="mb-2">
        <label for="redis" class="form-label"
          ><span
            class="text-decoration-underline"
            data-bs-toggle="collapse"
            href="#redisCollapse"
            role="button"
            aria-expanded="false"
            aria-controls="redisCollapse"
          >
            View/edit Redis info</span
          >
          (<a target="_blank" href="https://github.com/nicolasff/webdis"
            >webdis</a
          >)
        </label>
        <div class="collapse" id="redisCollapse">
          <textarea
            class="form-control"
            rows="6"
            id="redis"
            style="font-size: 0.8em"
          ></textarea>
        </div>
      </div>
    </div>

    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL"
      crossorigin="anonymous"
    ></script>

    <script>
      const logContainer = document.querySelector('#log');
      const redisContainer = document.querySelector('#redis');
      function log(message) {
        const line = `[${new Date().toISOString()}] ${message}\n`;
        console.log(line);
        logContainer.value += line;
        logContainer.scrollTop = logContainer.scrollHeight;
      }

      async function readClipboard() {
        try {
          const permission = await navigator.permissions.query({
            name: 'clipboard-read',
          });
          if (permission.state === 'denied') {
            return {
              type: null,
              data: 'No read permission for clipboard',
            };
          }
        } catch {
          // https://developer.mozilla.org/en-US/docs/Web/API/Permissions_API#browser_compatibility
          log('Permission "clipboard-read" not supported');
        }

        let items;
        try {
          items = await navigator.clipboard.read();
        } catch (e) {
          return {
            type: null,
            data: `Failed to read clipboard: ${e.name} ${e.message}`,
          };
        }

        if (items.length === 0) {
          return {
            type: null,
            data: 'Clipboard empty',
          };
        }

        for (const [index, item] of items.entries()) {
          log(`Local clipboard item ${index}: ${item.types}`);
        }

        const item = items[0];
        if (item.types.includes('image/png')) {
          const blob = await item.getType('image/png');
          return { type: 'image', data: blob };
        } else if (item.types.includes('text/plain')) {
          const blob = await item.getType('text/plain');
          const text = await blob.text();
          return { type: 'text', data: text };
        } else {
          return {
            type: null,
            data: `Unknown clipboard MIME types: "${item.types}"`,
          };
        }
      }

      function getHeaders() {
        return {
          headers: {
            Authorization:
              'Basic ' + btoa(`${redis.username}:${redis.password}`),
          },
        };
      }

      async function fetchCloudData() {
        let text = fetch(
          `${redis.host}GET/${redis.prefix}:clipboard:text.txt`,
          { method: 'GET', ...getHeaders() }
        )
          .then((response) => {
            if (response.ok) {
              return response.text();
            }
            throw new Error();
          })
          .catch(() => null);
        let image = fetch(
          `${redis.host}GET/${redis.prefix}:clipboard:image.png`,
          { method: 'GET', ...getHeaders() }
        )
          .then((response) => {
            if (response.ok) {
              return response.blob();
            }
            throw new Error();
          })
          .catch(() => null);

        text = await text;
        image = await image;
        if (text !== null && image === null) {
          return { type: 'text', data: text };
        } else if (text === null && image !== null) {
          return { type: 'image', data: image };
        } else {
          return {
            type: null,
            data: 'Error data from cloud. Check the console for details',
          };
        }
      }

      function showClipboard({ type, data }, container) {
        if (type === 'image') {
          const image = new Image();
          image.src = URL.createObjectURL(data);
          image.classList.add('shadow');
          container.replaceChildren(image);
        } else if (type === 'text') {
          const node = document.createElement('textarea');
          node.value = data;
          node.classList.add('form-control');
          node.rows = 5;
          node.readOnly = true;
          container.replaceChildren(node);
        } else {
          const node = document.createElement('p');
          node.innerText = data;
          node.style.color = 'red';
          container.replaceChildren(node);
        }
      }

      let local;
      let cloud;
      let redis;

      const localContainer = document.querySelector('#local');
      const cloudContainer = document.querySelector('#cloud');

      async function getAndShowLocalClipboard() {
        local = await readClipboard();
        showClipboard(local, localContainer);
      }

      async function getAndShowCloudClipboard() {
        cloud = await fetchCloudData();
        showClipboard(cloud, cloudContainer);
      }

      const identifier = (Math.random() + 1).toString(36).substring(2);
      async function pushToCloud() {
        // Get newest local clipboard data.
        // The local clipboard data can not be automatically updated
        // as user interacting is needed to read clipboard
        await getAndShowLocalClipboard();
        const { type, data } = local;
        log('Begin pushing to cloud');
        try {
          if (type === 'image') {
            await Promise.all([
              fetch(`${redis.host}SET/${redis.prefix}:clipboard:image`, {
                method: 'PUT',
                ...getHeaders(),
                body: data,
              }),
              fetch(`${redis.host}DEL/${redis.prefix}:clipboard:text`, {
                method: 'GET',
                ...getHeaders(),
              }),
            ]);
          } else if (type === 'text') {
            await Promise.all([
              fetch(`${redis.host}SET/${redis.prefix}:clipboard:text`, {
                method: 'PUT',
                ...getHeaders(),
                body: data,
              }),
              fetch(`${redis.host}DEL/${redis.prefix}:clipboard:image`, {
                method: 'GET',
                ...getHeaders(),
              }),
            ]);
          } else {
            log(`Failed to push to cloud: unknown type ${type}`);
            return;
          }
          // Publish the change only after successfully pushing data
          await fetch(
            `${redis.host}PUBLISH/${redis.prefix}:clipboard/change-from-${identifier}`,
            {
              method: 'GET',
              ...getHeaders(),
            }
          );
        } catch (e) {
          log(`Failed to push to cloud: ${e.message}, ${e.stack}`);
          return;
        }
        log('Finish pushing to cloud');
        cloud = local;
        showClipboard(cloud, cloudContainer);
      }

      async function pullToLocal() {
        // `cloud` is already the newest data
        const { type, data } = cloud;
        log('Begin pulling to local');
        try {
          if (type === 'image') {
            await navigator.clipboard.write([
              new ClipboardItem({ 'image/png': data }),
            ]);
          } else if (type === 'text') {
            const blob = new Blob([data], { type: 'text/plain' });
            await navigator.clipboard.write([
              new ClipboardItem({ 'text/plain': blob }),
            ]);
          } else {
            log(`Failed to pull to local: unknown type ${type}`);
            return;
          }
        } catch (e) {
          log(`Failed to pull to local: ${e.message}, ${e.stack}`);
          return;
        }
        log('Finish pulling to local');
        local = cloud;
        showClipboard(local, localContainer);
      }

      function longPolling() {
        log('Start long polling connection');
        const xhr = new XMLHttpRequest();
        let previousLength = 0;
        xhr.onreadystatechange = () => {
          if (xhr.readyState == XMLHttpRequest.LOADING) {
            const currentText = xhr.responseText;
            const chunk = currentText.slice(previousLength);
            previousLength = currentText.length;
            if (!chunk.includes(identifier) && chunk.includes('"message"')) {
              // Respond to updates from others to save a network request
              log('Change detected for cloud clipboard, updating');
              getAndShowCloudClipboard();
            }
          } else if (xhr.readyState == XMLHttpRequest.DONE) {
            // Restart the long polling
            longPolling();
          }
        };
        xhr.open(
          'GET',
          `${redis.host}SUBSCRIBE/${redis.prefix}:clipboard`,
          true
        );
        xhr.setRequestHeader(
          'Authorization',
          getHeaders().headers.Authorization
        );
        xhr.send(null);
      }

      window.addEventListener('DOMContentLoaded', async () => {
        const storage = localStorage.getItem('redis');
        if (storage === null) {
          redis = {
            host: 'https://example.com/',
            prefix: 'prefix',
            username: 'username',
            password: 'password',
          };
          log('Redis info not found in local storage');
        } else {
          redis = JSON.parse(storage);
          log('Load redis info from local storage');
        }
        redisContainer.value = JSON.stringify(redis, null, 4);

        redisContainer.addEventListener('input', () => {
          redis = JSON.parse(redisContainer.value);
          localStorage.setItem('redis', redisContainer.value);
          log('Redis info changed');
        });

        getAndShowLocalClipboard();
        getAndShowCloudClipboard();
        longPolling();
      });
    </script>
  </body>
</html>
